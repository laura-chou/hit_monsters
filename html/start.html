<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="../images/punching.png">
  <link rel="stylesheet" href="../css/bootstrap.min.css">
  <link rel="stylesheet" href="../css/common.style.css">
  <link rel="stylesheet" href="../css/start.styles.css">
  <title>怪獸終結者</title>
</head>
<body onselectstart="return false">
  <section id="start">
    <div class="player-info">
      <div class="level">
        <span>關卡 1</span>
      </div>
      <div class="hp">
        <img class="icon" src="../images/heart.png">
        <div class="hp-container">
          <div class="hp-bar player"></div>
          <div class="hp-value player"></div>
        </div>
      </div>
      <div class="attack">
        <img class="icon" src="../images/punching.png">
        <span class="player-attack"></span>
        <div class="select-number"></div>
      </div>
    </div>
    <div class="monster-info">
      <img class="monster-icon">
      <div>
        <div class="hp">
          <img class="icon" src="../images/heart.png">
          <div class="hp-container">
            <div class="hp-bar monster"></div>
            <div class="hp-value monster"></div>
          </div>
        </div>
        <div class="attack">
          <img class="icon" src="../images/claw.png">
          <span class="monster-attack"></span>
        </div>
      </div>
    </div>
    <div class="playground">
      <table>
        <tr>
            <td value=0>
              <div class="head"></div>
            </td>
            <td value=1>
              <div class="head"></div>
            </td>
            <td value=2>
              <div class="head"></div>
            </td>
        </tr>
        <tr>
            <td value=3>
              <div class="head"></div>
            </td>
            <td value=4>
              <div class="head"></div>
            </td>
            <td value=5>
              <div class="head"></div>
            </td>
        </tr>
        <tr>
            <td value=6>
              <div class="head"></div>
            </td>
            <td value=7>
              <div class="head"></div>
            </td>
            <td value=8>
              <div class="head"></div>
            </td>
        </tr>
      </table>
    </div>
  </section>
  <div id="settle" class="d-none">
    <span class="fs-3 m-5">下一關</span>
    <div class="d-flex align-items-center entity">
      <div class="text-center">
        <div>
          <div class="hp">
            <img class="icon" src="../images/heart.png">
            <span class="next player-life"></span>
          </div>
          <div class="attack">
            <img class="icon" src="../images/punching.png">
            <span class="next player-attack"></span>
          </div>
        </div>
      </div>
      <div class="ms-4 me-4">
        <img class="vs" src="../images/thunder.png">
      </div>
      <div class="text-center">
        <img class="next monster-icon">
        <div>
          <div class="hp">
            <img class="icon" src="../images/heart.png">
            <span class="next monster-life"></span>
          </div>
          <div class="attack">
            <img class="icon" src="../images/claw.png">
            <span class="next monster-attack"></span>
          </div>
        </div>
      </div>
    </div>
    <div class="reward-toggle m-5">
      <input type="radio" id="reward-life" name="reward" checked>
      <label class="reward" for="reward-life">
        <img src="../images/heart.png">
        <span></span>
      </label>

      <input type="radio" id="reward-attack" name="reward">
      <label class="reward" for="reward-attack">
        <img src="../images/punching.png">
        <span></span>
      </label>
    </div>
    <button id="next-level" type="button" class="btn btn-danger fw-bold">GO</button>
  </section>
</body>
<script src="../js/jquery-3.7.1.min.js"></script>
<script src="../js/sweetalert2@11.js"></script>
<script src="../js/bootstrap.bundle.min.js"></script>
<script type="module">
  import { getRandomsNoConsecutive, getRewardData, redirectToHome, playAudioEffect } from "../js/common.js";
  import { getTime, setPlayerInfo, getPlayerInfo, setLevelMonsters, setMonsterInfo, getMonsterInfo } from "../js/store.js";
  import { timeTo } from "../js/timer.js";

  let lockPlayer = true;
  let selectIndex = [];
  let appearIndex = [];
  let playerInfo = {};
  let monsterInfo = {};

  $(() => {
    if (getMonsterInfo() === null) {
      setLevelMonsters();
      setPlayerInfo(getPlayerInfo());
      setMonsterInfo(null);
      timeTo();
    }
    showPlayerInfo();
    showMonsterInfo();
    monsterAction();
    if (playerInfo.settle) {
      $("#start").addClass("d-none");
      $("#settle").removeClass("d-none");
      showPlayerInfo(true);
      showMonsterInfo(true);
    }
  })

  const monsterAction = () => {
    $(".monster-icon").addClass("monster-active");
    appearIndex = getRandomsNoConsecutive(3, $(".head").length - 1);
    appearIndex.forEach((idx, i) => {
      const appearTime = (i + 1) * 1000;
      const duration = 1000;

      setTimeout(() => {
        playAudioEffect("swoosh");
        $(".head").eq(idx)
          .addClass("appear")
          .css("background-image", `url("../images/monster${monsterInfo.id}.png")`);

        setTimeout(() => {
          $(".head").eq(idx).removeClass("appear");
          if(i === appearIndex.length - 1) {
            $(".monster-icon").removeClass("monster-active");
            lockPlayer = false;
          }
        }, duration);
      }, appearTime);
    });
  }

  $("td").on("click", (event) => {
    if (lockPlayer) {
      event.preventDefault();
      return;
    }
    playAudioEffect("press");
    if (selectIndex.length !== appearIndex.length) {
      selectIndex.push(parseInt($(event.target).attr("value")));
    }
    const showToPlayer = selectIndex.map(x => x + 1);
    $(".select-number").text(showToPlayer.join(" "))
    if (selectIndex.length === appearIndex.length) {
      lockPlayer = true;
      setTimeout(() => {
        if (appearIndex.every((val, idx) => val === selectIndex[idx])) {
          playAudioEffect("hit");
          $(".monster-icon").addClass("hit");
          monsterInfo.life-=playerInfo.attack;
          setMonsterInfo(monsterInfo);
          showMonsterInfo();
        } else {
          playAudioEffect("monster");
          $(".monster-icon").addClass("monster-attack");
          setTimeout(() => {
            playerInfo.life-=monsterInfo.attack;
            setPlayerInfo(playerInfo);
            showPlayerInfo();
          }, 500);
        }
        setTimeout(() => {
          $(".monster-icon").removeClass("hit monster-attack");
          $(".select-number").text("")
          selectIndex.length = 0
          checkGameOver();
        }, 1500)
      }, 1000)
    }
  });

  const checkGameOver = () => {
    if (playerInfo.life === 0 || monsterInfo.life === 0) {
      timeTo("stop");
      if (isPlayerWin()) {
        if (playerInfo.rank === 3) {
          playAudioEffect("complete");
          Swal.fire({
            imageUrl: "../images/book.png",
            imageWidth: 80,
            imageHeight: 80,
            title: "勇者之名，銘刻史冊",
            html: `<span class='fs-5 fw-bold'>通關時間 ${getTime()}</span>`,
            inputPlaceholder: "請輸入名字",
            input: "text",
            inputAttributes: {
              autocapitalize: "off"
            },
            allowOutsideClick: false,
            confirmButtonText: "確定",
            preConfirm: (player) => {
              if (player.trim() === "") {
                return Swal.showValidationMessage("請輸入名字");
              }
            }
          }).then((result) => {
            redirectToHome();
          });
        } else {
          playAudioEffect("level");
          playerInfo.rank++;
          playerInfo.settle = true;
          setPlayerInfo(playerInfo);
          setMonsterInfo(null);
          $("#start").addClass("d-none");
          $("#settle").removeClass("d-none");

          showPlayerInfo(true);
          showMonsterInfo(true);
        }
      } else {
        playAudioEffect("lose");
        Swal.fire({
          imageUrl: "../images/grave.png",
          imageWidth: 80,
          imageHeight: 80,
          allowOutsideClick: false,
          title: "勇者殞落，黑暗再度蔓延",
          confirmButtonText: "確定"
        }).then((result) => {
          redirectToHome();
        });
      }
    } else {
      monsterAction();
    }
  }

  const isPlayerWin = () => {
    return monsterInfo.life === 0;
  }

  const showMonsterInfo = (isNextLevel = false) => {
    monsterInfo = getMonsterInfo();
    if (isNextLevel) {
      $(".next.monster-icon").attr("src", `../images/monster${monsterInfo.id}.png`);
      $(".next.monster-life").text(monsterInfo.life);
      $(".next.monster-attack").text(monsterInfo.attack);
    } else {
      $(".hp-bar.monster").css("width", `${monsterInfo.life}%`);
      $(".hp-value.monster").text(monsterInfo.life);
      $(".monster-attack").text(monsterInfo.attack);
      $(".monster-icon").attr("src", `../images/monster${monsterInfo.id}.png`);
    }
  }

  const showPlayerInfo = (isNextLevel = false) => {
    playerInfo = getPlayerInfo();
    if (isNextLevel) {
      rewardPicked("life");
    } else {
      $(".hp-bar.player").css("width", `${playerInfo.life}%`);
      $(".hp-value.player").text(playerInfo.life);
      $(".player-attack").text(playerInfo.attack);
    }
  }

  $("#reward-life").on("click", () => {
    rewardPicked("life");
  });

  $("#reward-attack").on("click", () => {
    rewardPicked("attack");
  });

  const rewardPicked = (type) => {
    const reward = getRewardData(playerInfo.rank);
    $('#reward-life').next('label').find('span').text(`+${reward.life}`);
    $('#reward-attack').next('label').find('span').text(`+${reward.attack}`);
    switch (type) {
      case "life":
        $(".next.player-life").text(playerInfo.originLife + reward.life);
        $(".next.player-attack").text(playerInfo.originAttack);
        break;
      case "attack":
        $(".next.player-life").text(playerInfo.originLife);
        $(".next.player-attack").text(playerInfo.originAttack + reward.attack);
        break;
    }
  }

  $("#next-level").on("click", () => {
    const life = parseInt($(".next.player-life").text());
    const attack = parseInt($(".next.player-attack").text());
    playerInfo.life = life;
    playerInfo.originLife = life;
    playerInfo.attack = attack;
    playerInfo.originAttack = attack;
    playerInfo.settle = false;
    setPlayerInfo(playerInfo);
    $("#start").removeClass("d-none");
    $("#settle").addClass("d-none")
    showPlayerInfo();
    showMonsterInfo();
    monsterAction();
    timeTo("start");
  });
</script>
</html>