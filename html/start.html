<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="../images/punching.png">
  <link rel="stylesheet" href="../css/bootstrap.min.css">
  <link rel="stylesheet" href="../css/common.style.css">
  <link rel="stylesheet" href="../css/start.styles.css">
  <title>怪獸終結者</title>
</head>
<body onselectstart="return false">
  <section id="start">
    <div class="player-info default-font">
      <div class="info-block level">
        <span></span>
      </div>
      <div class="info-block">
        <img class="icon" src="../images/heart.png">
        <div class="hp-container">
          <div class="hp-bar player"></div>
          <div class="hp-value player"></div>
        </div>
      </div>
      <div class="info-block">
        <img class="icon" src="../images/punching.png">
        <span class="player-attack"></span>
        <div class="select-number"></div>
      </div>
    </div>
    <div class="monster-info default-font">
      <div class="monster-wrap">
        <img class="monster-icon">
      </div>
      <div>
        <div class="info-block">
          <img class="icon" src="../images/heart.png">
          <div class="hp-container">
            <div class="hp-bar monster"></div>
            <div class="hp-value monster"></div>
          </div>
        </div>
        <div class="info-block">
          <img class="icon" src="../images/claw.png">
          <span class="monster-attack"></span>
        </div>
      </div>
    </div>
    <div class="playground">
      <table>
        <tr>
            <td value=0>
              <div class="head"></div>
            </td>
            <td value=1>
              <div class="head"></div>
            </td>
            <td value=2>
              <div class="head"></div>
            </td>
        </tr>
        <tr>
            <td value=3>
              <div class="head"></div>
            </td>
            <td value=4>
              <div class="head"></div>
            </td>
            <td value=5>
              <div class="head"></div>
            </td>
        </tr>
        <tr>
            <td value=6>
              <div class="head"></div>
            </td>
            <td value=7>
              <div class="head"></div>
            </td>
            <td value=8>
              <div class="head"></div>
            </td>
        </tr>
      </table>
    </div>
  </section>
  <div id="settle" class="d-none default-font">
    <span class="title fs-3 m-5">準備迎戰</span>
    <div class="d-flex align-items-center entity">
      <div class="text-center">
        <div>
          <div class="info-block">
            <img class="icon" src="../images/heart.png">
            <span class="next player-life"></span>
          </div>
          <div class="info-block">
            <img class="icon" src="../images/punching.png">
            <span class="next player-attack"></span>
          </div>
        </div>
      </div>
      <div class="ms-4 me-4">
        <img class="vs" src="../images/thunder.png">
      </div>
      <div class="text-center">
        <img class="next monster-icon">
        <div>
          <div class="info-block">
            <img class="icon" src="../images/heart.png">
            <span class="next monster-life"></span>
          </div>
          <div class="info-block">
            <img class="icon" src="../images/claw.png">
            <span class="next monster-attack"></span>
          </div>
          <div class="info-block">
            <img class="next icon">
            <span class="next monster-times"></span>
          </div>
        </div>
      </div>
    </div>
    <div class="reward-toggle m-5 d-none">
      <input type="radio" id="reward-life" name="reward" checked>
      <label class="reward" for="reward-life">
        <img src="../images/heart.png">
        <span></span>
      </label>

      <input type="radio" id="reward-attack" name="reward">
      <label class="reward" for="reward-attack">
        <img src="../images/punching.png">
        <span></span>
      </label>
    </div>
    <button id="next-level" type="button" class="btn btn-danger fw-bold mt-5">GO</button>
  </section>
</body>
<script src="../js/jquery-3.7.1.min.js"></script>
<script src="../js/sweetalert2@11.js"></script>
<script src="../js/bootstrap.bundle.min.js"></script>
<script src="../js/confetti.browser.min.js"></script>
<script type="module">
  import { getRandomsNoConsecutive, getRewardData, redirectToHome, isNullOrEmpty, serverError } from "../js/common.js";
  import { getTime, setPlayerInfo, getPlayerInfo, setLevelMonsters, setMonsterInfo, getMonsterInfo, insertPlayer } from "../js/store.js";
  import { playAudioEffect, calcLifePercent, isPlayerWin, getGameRules } from "../js/start.js"
  import { timeTo } from "../js/timer.js";

  let lockPlayer = true;
  let selectIndex = [];
  let appearIndex = [];
  let playerInfo = {};
  let monsterInfo = {};

  $(() => {
    // Safari/iOS requires a touchstart listener to properly trigger CSS :active state on elements
    document.addEventListener("touchstart", () => {}, {passive: true});

    if (getMonsterInfo() === null) {
      setLevelMonsters();
      setPlayerInfo(getPlayerInfo());
      setMonsterInfo(null);
    }
    showPlayerInfo();
    showMonsterInfo();
    if (playerInfo.settle) {
      $("#start").addClass("d-none");
      $("#settle").removeClass("d-none");
      showPlayerInfo(true);
      showMonsterInfo(true);
    } else {
      timeTo();
      monsterAction();
    }
  })

  const monsterAction = () => {
    $(".monster-icon").addClass("monster-active");
    appearIndex = getRandomsNoConsecutive(monsterInfo.times, $(".head").length - 1);
    appearIndex.forEach((idx, i) => {
      const appearTime = (i + 1) * 1000;
      const duration = 1000;

      setTimeout(() => {
        playAudioEffect("swoosh");
        $(".head").eq(idx)
          .addClass("appear")
          .css("background-image", `url("../images/monster${monsterInfo.id}.png")`);

        setTimeout(() => {
          $(".head").eq(idx).removeClass("appear");
          if(i === appearIndex.length - 1) {
            $(".monster-icon").removeClass("monster-active");
            lockPlayer = false;
          }
        }, duration);
      }, appearTime);
    });
  }

  $("td").on("click", (event) => {
    if (lockPlayer) {
      event.preventDefault();
      return;
    }
    playAudioEffect("press");
    if (selectIndex.length !== appearIndex.length) {
      selectIndex.push(parseInt($(event.target).attr("value")));
    }
    const showToPlayer = selectIndex.map(x => x + 1);
    $(".select-number").text(showToPlayer.join(" "));
    if (selectIndex.length === appearIndex.length) {
      lockPlayer = true;
      setTimeout(() => {
        if (appearIndex.every((val, idx) => val === selectIndex[idx])) {
          playAudioEffect("hit");
          $(".monster-icon").addClass("hit");
          monsterInfo.currentLife-=playerInfo.originAttack;
          setMonsterInfo(monsterInfo);
          showMonsterInfo();
        } else {
          playAudioEffect("monster");
          $(".monster-icon").addClass("monster-attack");
          setTimeout(() => {
            playerInfo.currentLife-=monsterInfo.originAttack;
            setPlayerInfo(playerInfo);
            showPlayerInfo();
          }, 500);
        }
        setTimeout(() => {
          $(".monster-icon").removeClass("hit monster-attack");
          $(".select-number").text("");
          selectIndex.length = 0;
          checkGameOver();
        }, 1500);
      }, 1000);
    }
  });

  const checkGameOver = () => {
    if (playerInfo.currentLife === 0 || monsterInfo.currentLife === 0) {
      timeTo("stop");
      if (isPlayerWin(monsterInfo.currentLife)) {
        if (playerInfo.rank === 5) {
          playAudioEffect("complete");
          Swal.fire({
            imageUrl: "../images/book.png",
            imageWidth: 80,
            imageHeight: 80,
            title: "勇者之名 銘刻史冊",
            html: `<span class="fs-5 fw-bold">通關時間 ${getTime()}</span>`,
            inputPlaceholder: "請輸入名字",
            input: "text",
            inputAttributes: {
              autocapitalize: "off"
            },
            allowOutsideClick: false,
            confirmButtonText: "確定",
            preConfirm: (player) => {
              if (isNullOrEmpty(player.trim())) {
                return Swal.showValidationMessage("請輸入名字");
              }
            }
          }).then(async (result) => {
            const response = await insertPlayer(result.value);
            if (response) {
              response.topFive ? topFiveEffect() : redirectToHome();
            } else {
              serverError();
            }
          });
        } else {
          playAudioEffect("level");
          playerInfo.rank++;
          playerInfo.settle = true;
          setPlayerInfo(playerInfo);
          setMonsterInfo(null);
          $("#start").addClass("d-none");
          $("#settle").removeClass("d-none");

          showPlayerInfo(true);
          showMonsterInfo(true);
        }
      } else {
        playAudioEffect("lose");
        Swal.fire({
          imageUrl: "../images/grave.png",
          imageWidth: 80,
          imageHeight: 80,
          allowOutsideClick: false,
          title: "勇者殞落\n黑暗再度蔓延",
          confirmButtonText: "確定"
        }).then((result) => {
          redirectToHome();
        });
      }
    } else {
      monsterAction();
    }
  }

  const topFiveEffect = () => {
    playAudioEffect("top");
    Swal.fire({
      imageUrl: "../images/scroll.png",
      imageWidth: 80,
      imageHeight: 80,
      allowOutsideClick: false,
      confirmButtonText: "確定",
      title: "恭喜！你的事蹟已進入前五名",
      didOpen: () => {
        const $canvas = $("<canvas>", { id: "confetti-canvas" })
          .css({
            position: "absolute",
            top: 0,
            left: 0,
            width: "100%",
            height: "100%",
            zIndex: 1
          });

        $(".swal2-container").append($canvas[0]);

        const myConfetti = confetti.create($canvas[0], { resize: true });

        myConfetti({
          particleCount: 150,
          startVelocity: 45,
          spread: 90,
          origin: { y: 0.6 },
          colors: ["#FFD700", "#FF4500", "#FFFFFF"],
          ticks: 500,
          gravity: 0.8
        });
      }
    }).then((result) => {
      redirectToHome();
    });
  }

  const showMonsterInfo = (isNextLevel = false) => {
    monsterInfo = getMonsterInfo();
    if (isNextLevel) {
      $(".next.monster-icon").attr("src", `../images/monster${monsterInfo.id}.png`);
      $(".next.monster-life").text(monsterInfo.currentLife);
      $(".next.monster-attack").text(monsterInfo.originAttack);
      $(".next.icon").attr("src", `../images/monster${monsterInfo.id}.png`);
      $(".next.monster-times").text(monsterInfo.times);
    } else {
      const percent = calcLifePercent(monsterInfo.currentLife, monsterInfo.originLife);
      $(".hp-bar.monster").css("width", `${percent}%`);
      $(".hp-value.monster").text(monsterInfo.currentLife);
      $(".monster-attack").text(monsterInfo.originAttack);
      $(".monster-icon").attr("src", `../images/monster${monsterInfo.id}.png`);
    }
  }

  const showPlayerInfo = (isNextLevel = false) => {
    playerInfo = getPlayerInfo();
    if (isNextLevel) {
      rewardPicked("life");
    } else {
      $(".level span").text(`關卡 ${playerInfo.rank}`);
      const percent = calcLifePercent(playerInfo.currentLife, playerInfo.originLife);
      $(".hp-bar.player").css("width", `${percent}%`);
      $(".hp-value.player").text(playerInfo.currentLife);
      $(".player-attack").text(playerInfo.originAttack);
    }
  }

  $("#reward-life").on("click", () => {
    rewardPicked("life");
  });

  $("#reward-attack").on("click", () => {
    rewardPicked("attack");
  });

  const rewardPicked = (type) => {
    const reward = getRewardData(playerInfo.rank);
    $("#reward-life").next("label").find("span").text(`+${reward.life}`);
    $("#reward-attack").next("label").find("span").text(`+${reward.attack}`);
    switch (type) {
      case "life":
        $("#reward-life").prop("checked", true);
        $(".next.player-life").text(playerInfo.originLife + reward.life);
        $(".next.player-attack").text(playerInfo.originAttack);
        break;
      case "attack":
        $("#reward-attack").prop("checked", true);
        $(".next.player-life").text(playerInfo.originLife);
        $(".next.player-attack").text(playerInfo.originAttack + reward.attack);
        break;
    }
    if (reward.life > 0) {
      $(".reward-toggle").removeClass("d-none");
      if (reward.rank === 5) {
        $(".title").text("最終戰")
      }
    } else {
      Swal.fire({
        confirmButtonText: "開始",
        allowOutsideClick: false,
        title: "遊玩方式",
        html: getGameRules()
      });
    }
  }

  $("#next-level").on("click", () => {
    if (playerInfo.rank > 1) {
      Swal.fire({
        title: "確定要戰鬥了嗎?",
        icon: "warning",
        showCancelButton: true,
        allowOutsideClick: false,
        reverseButtons: true,
        confirmButtonText: "確定",
        cancelButtonText: "取消"
      }).then((result) => {
        if (result.isConfirmed) {
          setNextLevel();
        }
      });
    } else {
      setNextLevel();
    }
  });

  const setNextLevel = () => {
    const life = parseInt($(".next.player-life").text());
    const attack = parseInt($(".next.player-attack").text());
    playerInfo.currentLife = life;
    playerInfo.originLife = life;
    playerInfo.originAttack = attack;
    playerInfo.settle = false;
    setPlayerInfo(playerInfo);
    $("#start").removeClass("d-none");
    $("#settle").addClass("d-none")
    showPlayerInfo();
    showMonsterInfo();
    monsterAction();
    timeTo();
  }
</script>
</html>