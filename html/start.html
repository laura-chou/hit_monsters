<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="../images/punching.png">
  <link rel="stylesheet" href="../css/common.style.css">
  <link rel="stylesheet" href="../css/start.styles.css">
  <title>怪獸終結者</title>
</head>
<body onselectstart="return false">
  <section>
    <div class="player-info">
      <div class="level">
        <span>關卡 1</span>
      </div>
      <div class="hp">
        <img class="icon" src="../images/heart.png">
        <div class="hp-container">
          <div class="hp-bar player"></div>
          <div class="hp-value player"></div>
        </div>
      </div>
      <div class="attack">
        <img class="icon" src="../images/punching.png">
        <span class="player-attack"></span>
        <div class="select-number"></div>
      </div>
    </div>
    <div class="monster-info">
      <img class="monster-icon">
      <div>
        <div class="hp">
          <img class="icon" src="../images/heart.png">
          <div class="hp-container">
            <div class="hp-bar monster"></div>
            <div class="hp-value monster"></div>
          </div>
        </div>
        <div class="attack">
          <img class="icon" src="../images/claw.png">
          <span class="monster-attack"></span>
        </div>
      </div>
    </div>

    <div class="playground">
      <table border="5px outset black">
        <tr>
            <td value=0>
              <div class="head"></div>
            </td>
            <td value=1>
              <div class="head"></div>
            </td>
            <td value=2>
              <div class="head"></div>
            </td>
        </tr>
        <tr>
            <td value=3>
              <div class="head"></div>
            </td>
            <td value=4>
              <div class="head"></div>
            </td>
            <td value=5>
              <div class="head"></div>
            </td>
        </tr>
        <tr>
            <td value=6>
              <div class="head"></div>
            </td>
            <td value=7>
              <div class="head"></div>
            </td>
            <td value=8>
              <div class="head"></div>
            </td>
        </tr>
      </table>
    </div>
  </section>
</body>
<script src="../js/jquery-3.7.1.min.js"></script>
<script type="module">
  import { randNumberWithMin } from "../js/common.js";
  import { setPlayerInfo, getPlayerInfo, setMonsterInfo, getMonsterInfo } from "../js/store.js";
  import { playAudioEffect } from "../js/start.js";
  import { startCountdown } from "../js/timer.js";
  // startCountdown(30)
  let lockPlayer = true;
  let selectIndex = [];
  let appearIndex = [];
  let playerInfo = {};
  let monsterInfo = {};

  $(() => {
    setPlayerInfo(null);
    setMonsterInfo(null);
    monsterAction();
    showMonsterInfo();
    showPlayerInfo();
  })

  const monsterAction = () => {
    $(".monster-icon").addClass("monster-active");
    appearIndex = getRandomsNoConsecutive(3, $(".head").length - 1);
    appearIndex.forEach((idx, i) => {
      const appearTime = (i + 1) * 1000;
      const duration = 1000;

      setTimeout(() => {
        $(".head").eq(idx)
          .addClass("appear")
          .css("background-image", `url("../images/monster${monsterInfo.id}.png")`);

        setTimeout(() => {
          $(".head").eq(idx).removeClass("appear");
          if(i === appearIndex.length - 1) {
            $(".monster-icon").removeClass("monster-active");
            lockPlayer = false;
          }
        }, duration);
      }, appearTime);
    });
  }

  const getRandomsNoConsecutive = (count, max) => {
    let result = [];
    for (let i = 0; i < count; i++) {
      let num;
      do {
        num = randNumberWithMin(0, max);
      } while (i > 0 && num === result[i - 1]);
      result.push(num);
    }
    return result;
  };

  $("td").on("click", (event) => {
    if (lockPlayer) {
      event.preventDefault();
      return;
    }
    if (selectIndex.length !== appearIndex.length) {
      selectIndex.push(parseInt($(event.target).attr("value")));
    }
    const showToPlayer = selectIndex.map(x => x + 1);
    $(".select-number").text(showToPlayer.join(" "))
    if (selectIndex.length === appearIndex.length) {
      lockPlayer = true;
      setTimeout(() => {
        if (appearIndex.every((val, idx) => val === selectIndex[idx])) {
          $(".monster-icon").addClass("hit");
          monsterInfo.life-=playerInfo.attack;
          setMonsterInfo(monsterInfo);
          showMonsterInfo();
        } else {
          $(".monster-icon").addClass("monster-attack");
          setTimeout(() => {
            playerInfo.life-=monsterInfo.attack;
            setPlayerInfo(playerInfo);
            showPlayerInfo();
          }, 500);
        }
        setTimeout(() => {
          $(".monster-icon").removeClass("hit monster-attack");
          $(".select-number").text("")
          selectIndex.length = 0
          checkGameOver();
        }, 1500)
      }, 1000)
    }
  });
  const checkGameOver = () => {    
    if (playerInfo.life === 0 || monsterInfo.life === 0) {

    } else {
      monsterAction();
    }
  }

  const showMonsterInfo = () => {
    monsterInfo = getMonsterInfo();
    $(".hp-bar.monster").css("width", `${monsterInfo.life}%`);
    $(".hp-value.monster").text(monsterInfo.life);
    $(".monster-attack").text(monsterInfo.attack);
    $(".monster-icon").attr("src", `../images/monster${monsterInfo.id}.png`);
  }

  const showPlayerInfo = () => {
    playerInfo = getPlayerInfo();
    $(".hp-bar.player").css("width", `${playerInfo.life}%`);
    $(".hp-value.player").text(playerInfo.life);
    $(".player-attack").text(playerInfo.attack);
  }
</script>
</html>